# Query Keys Configuration Guide

## üìç Location
`frontend/src/libs/react-query/queryKeys.ts`

---

## üéØ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå

Query Keys Configuration ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ query keys ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö React Query ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ:

1. ‚úÖ **Type-safe** - ‡∏°‡∏µ TypeScript intellisense ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
2. ‚úÖ **Consistent** - ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ keys ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
3. ‚úÖ **Easy Invalidation** - Invalidate queries ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
4. ‚úÖ **Maintainable** - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà

---

## üìñ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Query Keys

### Pattern ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô

```typescript
const entityKeys = {
  all: ['entity'] as const,                        // Base key
  lists: () => [...entityKeys.all, 'list'] as const,
  list: (filters?) => [...entityKeys.lists(), filters] as const,
  details: () => [...entityKeys.all, 'detail'] as const,
  detail: (id) => [...entityKeys.details(), id] as const,
  relation: (id) => [...entityKeys.detail(id), 'relation'] as const,
};
```

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: Students

```typescript
export const studentKeys = {
  all: ['students'],                      // ['students']
  lists: () => ['students', 'list'],      // ['students', 'list']
  list: (filters) => ['students', 'list', filters],
  // ['students', 'list', { classroomId: '123' }]

  details: () => ['students', 'detail'],  // ['students', 'detail']
  detail: (id) => ['students', 'detail', id],
  // ['students', 'detail', 'student-123']

  trophy: (id) => ['students', 'detail', id, 'trophy'],
  // ['students', 'detail', 'student-123', 'trophy']
};
```

---

## üîß ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### 1. ‡πÉ‡∏ô Query Hooks

```typescript
// ‚ùå ‡πÄ‡∏î‡∏¥‡∏°: Hard-coded keys
import { useQuery } from '@tanstack/react-query';

export const useStudents = (filters) => {
  return useQuery({
    queryKey: ['students', 'list', filters], // ‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥ structure
    queryFn: fetchStudents,
  });
};

// ‚úÖ ‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ centralized keys
import { useQuery } from '@tanstack/react-query';
import { queryKeys } from '@/libs/react-query/queryKeys';

export const useStudents = (filters) => {
  return useQuery({
    queryKey: queryKeys.students.list(filters), // ‚úÖ Type-safe + autocomplete
    queryFn: fetchStudents,
  });
};
```

---

### 2. ‡πÉ‡∏ô Mutations (Invalidation)

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { queryKeys } from '@/libs/react-query/queryKeys';

export const useUpdateStudent = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: updateStudent,
    onSuccess: (data, variables) => {
      // ‚úÖ Invalidate specific student
      queryClient.invalidateQueries({
        queryKey: queryKeys.students.detail(variables.id)
      });

      // ‚úÖ Invalidate all students lists
      queryClient.invalidateQueries({
        queryKey: queryKeys.students.lists()
      });

      // ‚úÖ Invalidate ALL students queries (list, detail, search, etc.)
      queryClient.invalidateQueries({
        queryKey: queryKeys.students.all
      });
    },
  });
};
```

---

### 3. ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Prefetch

```typescript
import { useQueryClient } from '@tanstack/react-query';
import { queryKeys } from '@/libs/react-query/queryKeys';

const StudentListPage = () => {
  const queryClient = useQueryClient();

  const handleRowHover = (studentId: string) => {
    // Prefetch student detail ‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover
    queryClient.prefetchQuery({
      queryKey: queryKeys.students.detail(studentId),
      queryFn: () => fetchStudent(studentId),
    });
  };

  return <StudentList onRowHover={handleRowHover} />;
};
```

---

## üìö Available Query Keys

### Statistics
```typescript
queryKeys.statistics.term(params)
// ['statistics', 'term', { startDate, endDate, ... }]
```

### Students
```typescript
queryKeys.students.all                    // ['students']
queryKeys.students.list(filters)          // ['students', 'list', filters]
queryKeys.students.search(query)          // ['students', 'search', query]
queryKeys.students.detail(id)             // ['students', 'detail', id]
queryKeys.students.trophy(id)             // ['students', 'detail', id, 'trophy']
```

### Departments
```typescript
queryKeys.departments.all                 // ['departments']
queryKeys.departments.list(filters)       // ['departments', 'list', filters]
queryKeys.departments.detail(id)          // ['departments', 'detail', id]
```

### Programs
```typescript
queryKeys.programs.all                    // ['programs']
queryKeys.programs.list(filters)          // ['programs', 'list', filters]
queryKeys.programs.detail(id)             // ['programs', 'detail', id]
```

### Teachers
```typescript
queryKeys.teachers.all                    // ['teachers']
queryKeys.teachers.list(filters)          // ['teachers', 'list', filters]
queryKeys.teachers.detail(id)             // ['teachers', 'detail', id]
queryKeys.teachers.classrooms(id)         // ['teachers', 'detail', id, 'classrooms']
queryKeys.teachers.students(id)           // ['teachers', 'detail', id, 'students']
```

### Classrooms
```typescript
queryKeys.classrooms.all                  // ['classrooms']
queryKeys.classrooms.list(filters)        // ['classrooms', 'list', filters]
queryKeys.classrooms.detail(id)           // ['classrooms', 'detail', id]
queryKeys.classrooms.students(id)         // ['classrooms', 'detail', id, 'students']
```

### Check-in
```typescript
queryKeys.checkIn.report(params)          // ['check-in', 'report', params]
queryKeys.checkIn.daily(params)           // ['check-in', 'report', 'daily', params]
```

### User Projects
```typescript
queryKeys.userProjects.list(query)        // ['user-projects', 'list', query]
```

### Images
```typescript
queryKeys.images.image(url, token)        // ['images', url, token]
```

### PDFs
```typescript
queryKeys.pdfs.pdf(url)                   // ['pdfs', url]
```

---

## üé® Invalidation Patterns

### 1. Invalidate Specific Item
```typescript
// Invalidate ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
queryClient.invalidateQueries({
  queryKey: queryKeys.students.detail('student-123')
});
```

### 2. Invalidate All Lists
```typescript
// Invalidate ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° detail)
queryClient.invalidateQueries({
  queryKey: queryKeys.students.lists()
});
```

### 3. Invalidate Everything
```typescript
// Invalidate ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
queryClient.invalidateQueries({
  queryKey: queryKeys.students.all
});
```

### 4. Invalidate Multiple Entities
```typescript
// Invalidate ‡∏´‡∏•‡∏≤‡∏¢ entity ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
const handleStudentUpdate = () => {
  queryClient.invalidateQueries({ queryKey: queryKeys.students.all });
  queryClient.invalidateQueries({ queryKey: queryKeys.classrooms.all });
  queryClient.invalidateQueries({ queryKey: queryKeys.statistics.all });
};
```

---

## ‚ú® Advanced Patterns

### 1. Related Data Invalidation

```typescript
export const useDeleteStudent = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: deleteStudent,
    onSuccess: (_, studentId) => {
      // Invalidate student data
      queryClient.invalidateQueries({
        queryKey: queryKeys.students.detail(studentId)
      });

      // Invalidate all students lists
      queryClient.invalidateQueries({
        queryKey: queryKeys.students.lists()
      });

      // Invalidate related classroom data
      queryClient.invalidateQueries({
        queryKey: queryKeys.classrooms.all
      });

      // Invalidate statistics
      queryClient.invalidateQueries({
        queryKey: queryKeys.statistics.all
      });
    },
  });
};
```

---

### 2. Optimistic Updates

```typescript
export const useUpdateStudent = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: updateStudent,
    onMutate: async (variables) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({
        queryKey: queryKeys.students.detail(variables.id)
      });

      // Snapshot previous value
      const previousStudent = queryClient.getQueryData(
        queryKeys.students.detail(variables.id)
      );

      // Optimistically update
      queryClient.setQueryData(
        queryKeys.students.detail(variables.id),
        variables.data
      );

      return { previousStudent };
    },
    onError: (err, variables, context) => {
      // Rollback on error
      queryClient.setQueryData(
        queryKeys.students.detail(variables.id),
        context?.previousStudent
      );
    },
    onSettled: (data, error, variables) => {
      // Refetch after success or error
      queryClient.invalidateQueries({
        queryKey: queryKeys.students.detail(variables.id)
      });
    },
  });
};
```

---

### 3. Conditional Queries

```typescript
const StudentProfile = ({ studentId }: { studentId?: string }) => {
  // Query ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å disable ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ studentId
  const { data: student } = useQuery({
    queryKey: queryKeys.students.detail(studentId!),
    queryFn: () => fetchStudent(studentId!),
    enabled: !!studentId, // Only run when studentId exists
  });

  return student ? <Profile data={student} /> : <EmptyState />;
};
```

---

## üîç Debugging Tips

### 1. ‡πÉ‡∏ä‡πâ React Query DevTools
```typescript
// DevTools ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á query keys ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ['students', 'detail', 'student-123']
```

### 2. Log Query Keys
```typescript
console.log('Query Key:', queryKeys.students.detail('123'));
// Output: ['students', 'detail', '123']
```

### 3. Check Cache
```typescript
const queryClient = useQueryClient();
const cachedData = queryClient.getQueryData(
  queryKeys.students.detail('123')
);
console.log('Cached Data:', cachedData);
```

---

## üìù Best Practices

### ‚úÖ DO

```typescript
// ‚úÖ ‡πÉ‡∏ä‡πâ query keys ‡∏à‡∏≤‡∏Å config
queryKey: queryKeys.students.list(filters)

// ‚úÖ Invalidate ‡πÅ‡∏ö‡∏ö hierarchical
queryClient.invalidateQueries({ queryKey: queryKeys.students.all })

// ‚úÖ Type-safe parameters
const params = { classroomId: '123' };
queryKey: queryKeys.students.list(params)
```

### ‚ùå DON'T

```typescript
// ‚ùå Hard-code query keys
queryKey: ['students', 'list', filters]

// ‚ùå Inconsistent naming
queryKey: ['student-list', filters]  // ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô students.list
queryKey: ['studentDetails', id]     // ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô students.detail

// ‚ùå Missing filters in key
queryKey: ['students'] // ‚ùå filters ‡∏à‡∏∞‡πÑ‡∏°‡πà trigger refetch
```

---

## üöÄ Adding New Entity Keys

### Template

```typescript
// frontend/src/libs/react-query/queryKeys.ts

export const newEntityKeys = {
  all: ['new-entity'] as const,
  lists: () => [...newEntityKeys.all, 'list'] as const,
  list: (filters?: Record<string, any>) => [...newEntityKeys.lists(), filters] as const,
  details: () => [...newEntityKeys.all, 'detail'] as const,
  detail: (id: string) => [...newEntityKeys.details(), id] as const,
  // Add custom relations
  customRelation: (id: string) => [...newEntityKeys.detail(id), 'custom'] as const,
};

// Don't forget to add to queryKeys export!
export const queryKeys = {
  // ... existing keys
  newEntity: newEntityKeys,
} as const;
```

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏° Activities

```typescript
export const activityKeys = {
  all: ['activities'] as const,
  lists: () => [...activityKeys.all, 'list'] as const,
  list: (filters?: { type?: string; date?: string }) =>
    [...activityKeys.lists(), filters] as const,
  details: () => [...activityKeys.all, 'detail'] as const,
  detail: (id: string) => [...activityKeys.details(), id] as const,
  participants: (id: string) => [...activityKeys.detail(id), 'participants'] as const,
};

// Add to export
export const queryKeys = {
  // ... existing
  activities: activityKeys,
} as const;
```

---

## üìä Summary

| Feature | Without Query Keys | With Query Keys |
|---------|-------------------|-----------------|
| **Type Safety** | ‚ùå None | ‚úÖ Full TypeScript |
| **Consistency** | ‚ùå Manual | ‚úÖ Automatic |
| **Autocomplete** | ‚ùå None | ‚úÖ IntelliSense |
| **Refactoring** | ‚ùå Find & Replace | ‚úÖ One Place |
| **Invalidation** | ‚ùå Error-prone | ‚úÖ Easy & Safe |
| **Debugging** | ‚ùå Hard | ‚úÖ DevTools Friendly |

---

## üéâ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

‚úÖ **Centralized Query Keys Complete!**

**‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:**
- üéØ **Type-safe** - TypeScript autocomplete ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
- üîí **Consistent** - ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
- üöÄ **Easy Invalidation** - Invalidate queries ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- üêõ **Better Debugging** - DevTools ‡πÅ‡∏™‡∏î‡∏á keys ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- üì¶ **Maintainable** - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà

---

## üìñ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

- [React Query Keys Best Practices](https://tkdodo.eu/blog/effective-react-query-keys)
- [Query Key Factories](https://tkdodo.eu/blog/leveraging-the-query-function-context)
